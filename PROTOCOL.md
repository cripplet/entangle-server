entangle-server protocol
====

Format
----

A message packet to / from `entangle-server` is expected to have the following format:

```
L:RESERVED:RESERVED:ACK:MSG_ID:CLIENT_ID:AUTH:CMD:ERR:AUX

# example client-side conection request
24::::182:::CONN::foobar123

# example server-side connection response
22:::1:182:ef893::CONN:0:
```

Note that *each field has arbitrary length*.

* `RESERVED` -- Reserved fields for future protocol expansion; will probably be of the form `LEN_RESERVED:RESERVED` to allow for arbitrary arguments in the second 
	`RESERVED` field. May be used for message encryption purposes. Currently, leave blank.
* `L` -- The total length of the packet, starting from the `ACK` field and ending at the last character of `AUX`. This does **not** include the `:` delimiter between `L` 
	and `ACK`.
* `ACK` -- Set to `0` or leave empty on a request and set to `1` on a response.
* `MSG_ID` -- Unique *numeric* message id for each request; this is mirrored on the response. Client sets `MSG_ID` on initial communication; each subsequent 
	*non-duplicate* request MUST be greater than each previous request
* `CLIENT_ID` -- Unique client id for a client; this is left empty on the original connection request and is filled in by the server.
* `AUTH` -- Client authentication token, set by the client in the initial `CONN` request. If `AUTH` is set, then all future requests by this client MUST include the same 
	token; otherwise, the server will respond with a `DENIED` error code. `AUTH` is left blank on all responses.
* `CMD` -- A *word* designating the command.
* `ERR` -- A numeric code designating an error. Left blank or set to `0` on no error.
* `AUX` -- Additional data for each command.

In the following protocol definition, `request` refers to the side initiating the command (the client) and `response` refers to the side fulfilling the command (the 
server). Fields which are obvious are left out (see previous explanation of fields for field values). The `error` section refers to the format of a response which cannot 
be fulfilled by the server due to various reasons. A list of possible error codes to be generated by the relevant response is included in this section. In addition, an 
`INVALID` error code will be returned by the server to *any* request if that request has invalid parameters or an incorrect format, OR `DENIED` if the request `AUTH` 
token does not match the token kept on the server.

Connection
----

### Request

| Field | Value |
| ----- | ----- |
| `MSG_ID` | initial message id |
| `CLIENT_ID` | blank |
| `AUTH` | blank or alphanumeric token |
| `CMD` | `CONN` |
| `AUX` | `P:T`, where `P` is the client port, and `T` an optional alphanumeric server token |

### Response

| Field | Value |
| ----- | ----- |
| `MSG_ID` | mirrored |
| `CLIENT_ID` | unique alphanumeric client id |
| `AUTH` | blank |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `DENIED` -- wrong password in the `AUX` field (if the server has chosen to set an access token on startup) -- this password is separate from the client token
* `MAX_CONN` -- server cannot accept client due to resource limitations

| Field | Value |
| ----- | ----- |
| `MSG_ID` | mirrored |
| `CLIENT_ID` | blank |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | blank |

Disconnect
----

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `DROP` |
| `AUX` | blank |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT` -- the client id is not recognized

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | blank |

Resize
----

Notify the server of the amount of data seen by the client. The client must afterwards send a `SYNC` packet, with `AUX` set to `1`. The server will attempt to keep the 
client buffer offset as-is until the buffer size is less than the client buffer offset.

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `RESIZE` |
| `AUX` | number of bytes seen by the client |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | blank |

Sync
----

Request a client buffer update.

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `SYNC` |
| `AUX` | `1` if client desires to flush the current client buffer |

### Response

A response may be generated by the server spontaneously WITHOUT prompting by the client. In this case, `MSG_ID` is set to a unique server-side value.

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | diff data |

### Response-Ack

The client, upon receiving the server response, MUST generate an `ACK` packet, with `MSG_ID` set to the same id as the original request or spontaneous response. The 
server, upon receiving response-ack, will update its internal client data buffer to match that of the client. The client, upon sending response-ack will update itself that 
it has synced with the server with last `SYNC` of `MSG_ID` -- if an `UNSYNC` error occurs later with `AUX` set to the saved `MSG_ID`, the client, upon receiving a 
response, does **not** need to re-sync the `AUX` field of response to itself, but **does** need to update the `MSG_ID` for the id of the current `SYNC` taking place.

| Field | Value |
| ----- | ----- |
| `ACK` | 1 |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | blank |

SyncPos
----

Server-generated packets -- the client MUST acknowledge a packet if the given client id in the `AUX` field matches its own -- otherwise, an `UNSYNC` error will be 
returned for future requests.

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | `SYNCPOS` |
| `AUX` | `C:P`, where `C` is the client id, and `P` the file offset |

### Response-Ack

| Field | Value |
| ----- | ----- |
| `ACK` | 1 |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | blank |

Seek
----

Adjust the client file pointer position accordingly. If resulting client offset is beyond the current client buffer, the server will send a `SYNC` packet.

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `SEEK` |
| `AUX` | `R:F:S`, where `R` is set to `1` if relative, `F` is set to `1` of client desires forward seek, and `S` is the seek offset |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Errors

Possible additional error codes:

* `NO_CLIENT`
* `UNSYNC` -- the client has not acknowledged a server `SYNC` response packet; a `SYNC` packet will be sent immediately after the error (to which the client must 
	respond)

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | `SYNC_MSG_ID:SYNCPOS_MSG_ID` of last successful `SYNC` and `SYNCPOS` if error code is `UNSYNC`, otherwise blank |

Overwrite
----

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `OVER` |
| `AUX` | alphanumeric string |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`
* `UNSYNC`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | `SYNC_MSG_ID:SYNCPOS_MSG_ID` of last successful `SYNC` and `SYNCPOS` if error code is `UNSYNC`, otherwise blank |

Insert
----

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `INSERT` |
| `AUX` | alphanumeric string |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`
* `UNSYNC`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | `SYNC_MSG_ID:SYNCPOS_MSG_ID` of last successful `SYNC` and `SYNCPOS` if error code is `UNSYNC`, otherwise blank |

Erase
----

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `ERASE` |
| `AUX` | numeric length |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`
* `UNSYNC`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | `SYNC_MSG_ID:SYNCPOS_MSG_ID` of last successful `SYNC` and `SYNCPOS` if error code is `UNSYNC`, otherwise blank |

Backspace
----

### Request

| Field | Value |
| ----- | ----- |
| `CMD` | `BACK` |
| `AUX` | numeric length |

### Response

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `AUX` | blank |

### Error

Possible additional error codes:

* `NO_CLIENT`
* `UNSYNC`

| Field | Value |
| ----- | ----- |
| `CMD` | mirrored |
| `ERR` | error code |
| `AUX` | `SYNC_MSG_ID:SYNCPOS_MSG_ID` of last successful `SYNC` and `SYNCPOS` if error code is `UNSYNC`, otherwise blank |

Error Codes
----

| Code | Designation | description |
| ---- | ----------- | ----------- |
| 0 | `NO_ERR` | no error |
| 400 | `INVALID` | invalid response received |
| 401 | `DENIED` | access denied |
| 404 | `NO_CLIENT` | client not found |
| 409 | `UNSYNC` | client is out of sync with server -- server will follow up with a `SYNC` and `SYNCPOS` packet |
| 503 | `MAX_CONN` | max connections |
